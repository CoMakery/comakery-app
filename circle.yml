machine:
    timezone:
        America/Los_Angeles

dependencies:
    cache_directories:
        - /home/ubuntu/.phantomjs
    pre:
        - gem install brakeman
        - nvm install 5
        - nvm alias default 5
        - nvm use default
        - cd ethereum && npm i
        - npm i -g 'github:ConsenSys/truffle#master'  # wants to run as global

database:
    override:
        - bundle exec rake db:create db:migrate               # check that migrations run successfully
        - bundle exec rake db:migrate VERSION=20160224202923  # migrate down until irreversible migration
        - git checkout db/schema.rb                           # revert to schema in repo
        - bundle exec rake db:reset                           # load from schema + seeds

test:
    pre:
        - cd ethereum && npm run testrpc:
            background: true
    override:
        - ./bin/rspect --format documentation:
            parallel: true
            files:
                - spec/**/*_spec.rb
        - brakeman --exit-on-warn
        - cd ethereum && truffle test

deployment:
    autodeploy:
        branch: master
        commands:
            - bin/deploy comakery-staging $CIRCLE_SHA1
